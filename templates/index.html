<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Iperstaroil – Monitoraggio Distributori</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-bottom: 4rem; }
    .badge-litri { font-variant-numeric: tabular-nums; }
    .sticky-top { top: 0.5rem; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-dark navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Iperstaroil</a>
    <div class="navbar-nav">
      <a class="nav-link" href="/mappa">Mappa</a>
      <a class="nav-link" href="/api/distributori" target="_blank">API Distributori</a>
    </div>
  </div>
</nav>

<div class="container my-3">
  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card sticky-top">
        <div class="card-body">
          <h5 class="card-title">Filtra per provincia</h5>
          <div class="input-group mb-3">
            <input id="provincia-input" class="form-control" placeholder="es. MI o Milano">
            <button id="btn-filtra" class="btn btn-primary">Cerca</button>
          </div>
          <div id="prov-summary" class="small text-muted"></div>
          <hr>
          <h6 class="card-subtitle mb-2">Aggiorna prezzi (provincia)</h6>
          <div class="mb-2">
            <label class="form-label">Prezzo Benzina (€/L)</label>
            <input id="prezzo-b" type="number" step="0.001" class="form-control" placeholder="es. 1.929">
          </div>
          <div class="mb-3">
            <label class="form-label">Prezzo Diesel (€/L)</label>
            <input id="prezzo-d" type="number" step="0.001" class="form-control" placeholder="es. 1.819">
          </div>
          <button id="btn-aggiorna" class="btn btn-warning w-100">Aggiorna prezzi provincia</button>
          <div id="aggiorna-msg" class="mt-2 small"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <h3 class="mb-3">Distributori (ordinati per ID)</h3>
      <div id="list" class="vstack gap-3"></div>
    </div>
  </div>
</div>

<script>
async function loadAll() {
  const res = await fetch('/api/distributori');
  const data = await res.json();
  renderList(data);
}

function renderList(items) {
  const list = document.getElementById('list');
  list.innerHTML = '';
  for (const d of items) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
          <div>
            <h5 class="card-title mb-1">#${d.id} – ${d.nome}</h5>
            <div class="text-muted">Provincia: <strong>${d.provincia}</strong></div>
            <div class="text-muted small">Coord: ${d.lat.toFixed(5)}, ${d.lon.toFixed(5)}</div>
          </div>
          <div class="text-end">
            <div>Prezzi</div>
            <div class="badge text-bg-success">Benzina: € ${d.prezzo_benzina.toFixed(3)}</div>
            <div class="badge text-bg-secondary">Diesel: € ${d.prezzo_diesel.toFixed(3)}</div>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col">
            <div>Livelli carburante</div>
            <span class="badge text-bg-primary badge-litri">Benzina: ${d.livello_carburante.benzina.toLocaleString()} L</span>
            <span class="badge text-bg-dark badge-litri">Diesel: ${d.livello_carburante.diesel.toLocaleString()} L</span>
          </div>
          <div class="col text-end">
            <a class="btn btn-sm btn-outline-primary" href="/distributore/${d.id}">Dettaglio</a>
          </div>
        </div>
      </div>`;
    list.appendChild(card);
  }
}

document.getElementById('btn-filtra').addEventListener('click', async () => {
  const prov = document.getElementById('provincia-input').value.trim();
  const out = document.getElementById('prov-summary');
  if (!prov) { out.textContent = 'Inserisci una provincia.'; return; }
  const res = await fetch('/api/distributori/provincia/' + encodeURIComponent(prov));
  if (res.ok) {
    const data = await res.json();
    out.innerHTML = `
      <div class="mb-2"><strong>${data.distributori.length}</strong> distributori in <strong>${data.provincia}</strong></div>
      <div>Totali: <span class="badge text-bg-primary">${(data.totali_litri.benzina || 0).toLocaleString()} L benzina</span>
      <span class="badge text-bg-dark">${(data.totali_litri.diesel || 0).toLocaleString()} L diesel</span></div>
    `;
    renderList(data.distributori.map(d => ({
      id: d.id,
      nome: d.nome,
      provincia: d.provincia,
      lat: 0, lon: 0,
      livello_carburante: d.livello_carburante,
      prezzo_benzina: d.prezzi.benzina,
      prezzo_diesel: d.prezzi.diesel
    })));
  } else {
    out.textContent = 'Nessun distributore trovato per la provincia indicata.';
  }
});

document.getElementById('btn-aggiorna').addEventListener('click', async () => {
  const prov = document.getElementById('provincia-input').value.trim();
  const b = document.getElementById('prezzo-b').value;
  const d = document.getElementById('prezzo-d').value;
  const msg = document.getElementById('aggiorna-msg');

  if (!prov) { msg.textContent = 'Inserisci una provincia.'; return; }
  const payload = {};
  if (b) payload.benzina = Number(b);
  if (d) payload.diesel = Number(d);
  if (!payload.benzina && !payload.diesel) {
    msg.textContent = 'Inserisci almeno un prezzo da aggiornare.'; return;
  }
  msg.textContent = 'Aggiornamento in corso...';
  const res = await fetch('/api/prezzi/provincia/' + encodeURIComponent(prov), {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload),
  });
  if (res.ok) {
    const data = await res.json();
    msg.textContent = `Aggiornati ${data.aggiornati} distributori in ${data.provincia}.`;
    loadAll();
  } else {
    const err = await res.text();
    msg.textContent = 'Errore: ' + err;
  }
});

loadAll();
</script>
</body>
</html>
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Iperstaroil – Monitoraggio Distributori</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-bottom: 4rem; }
    .badge-litri { font-variant-numeric: tabular-nums; }
    .sticky-top { top: 0.5rem; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-dark navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Iperstaroil</a>
    <div class="navbar-nav">
      <a class="nav-link" href="/mappa">Mappa</a>
      <a class="nav-link" href="/api/distributori" target="_blank">API Distributori</a>
    </div>
  </div>
</nav>

<div class="container my-3">
  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card sticky-top">
        <div class="card-body">
          <h5 class="card-title">Filtra per provincia</h5>
          <div class="input-group mb-3">
            <input id="provincia-input" class="form-control" placeholder="es. MI o Milano">
            <button id="btn-filtra" class="btn btn-primary">Cerca</button>
          </div>
          <div id="prov-summary" class="small text-muted"></div>
          <hr>
          <h6 class="card-subtitle mb-2">Aggiorna prezzi (provincia)</h6>
          <div class="mb-2">
            <label class="form-label">Prezzo Benzina (€/L)</label>
            <input id="prezzo-b" type="number" step="0.001" class="form-control" placeholder="es. 1.929">
          </div>
          <div class="mb-3">
            <label class="form-label">Prezzo Diesel (€/L)</label>
            <input id="prezzo-d" type="number" step="0.001" class="form-control" placeholder="es. 1.819">
          </div>
          <button id="btn-aggiorna" class="btn btn-warning w-100">Aggiorna prezzi provincia</button>
          <div id="aggiorna-msg" class="mt-2 small"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <h3 class="mb-3">Distributori (ordinati per ID)</h3>
      <div id="list" class="vstack gap-3"></div>
    </div>
  </div>
</div>

<script>
async function loadAll() {
  const res = await fetch('/api/distributori');
  const data = await res.json();
  renderList(data);
}

function renderList(items) {
  const list = document.getElementById('list');
  list.innerHTML = '';
  for (const d of items) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
          <div>
            <h5 class="card-title mb-1">#${d.id} – ${d.nome}</h5>
            <div class="text-muted">Provincia: <strong>${d.provincia}</strong></div>
            <div class="text-muted small">Coord: ${d.lat.toFixed(5)}, ${d.lon.toFixed(5)}</div>
          </div>
          <div class="text-end">
            <div>Prezzi</div>
            <div class="badge text-bg-success">Benzina: € ${d.prezzo_benzina.toFixed(3)}</div>
            <div class="badge text-bg-secondary">Diesel: € ${d.prezzo_diesel.toFixed(3)}</div>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col">
            <div>Livelli carburante</div>
            <span class="badge text-bg-primary badge-litri">Benzina: ${d.livello_carburante.benzina.toLocaleString()} L</span>
            <span class="badge text-bg-dark badge-litri">Diesel: ${d.livello_carburante.diesel.toLocaleString()} L</span>
          </div>
          <div class="col text-end">
            <a class="btn btn-sm btn-outline-primary" href="/distributore/${d.id}">Dettaglio</a>
          </div>
        </div>
      </div>`;
    list.appendChild(card);
  }
}

document.getElementById('btn-filtra').addEventListener('click', async () => {
  const prov = document.getElementById('provincia-input').value.trim();
  const out = document.getElementById('prov-summary');
  if (!prov) { out.textContent = 'Inserisci una provincia.'; return; }
  const res = await fetch('/api/distributori/provincia/' + encodeURIComponent(prov));
  if (res.ok) {
    const data = await res.json();
    out.innerHTML = `
      <div class="mb-2"><strong>${data.distributori.length}</strong> distributori in <strong>${data.provincia}</strong></div>
      <div>Totali: <span class="badge text-bg-primary">${(data.totali_litri.benzina || 0).toLocaleString()} L benzina</span>
      <span class="badge text-bg-dark">${(data.totali_litri.diesel || 0).toLocaleString()} L diesel</span></div>
    `;
    renderList(data.distributori.map(d => ({
      id: d.id,
      nome: d.nome,
      provincia: d.provincia,
      lat: 0, lon: 0,
      livello_carburante: d.livello_carburante,
      prezzo_benzina: d.prezzi.benzina,
      prezzo_diesel: d.prezzi.diesel
    })));
  } else {
    out.textContent = 'Nessun distributore trovato per la provincia indicata.';
  }
});

document.getElementById('btn-aggiorna').addEventListener('click', async () => {
  const prov = document.getElementById('provincia-input').value.trim();
  const b = document.getElementById('prezzo-b').value;
  const d = document.getElementById('prezzo-d').value;
  const msg = document.getElementById('aggiorna-msg');

  if (!prov) { msg.textContent = 'Inserisci una provincia.'; return; }
  const payload = {};
  if (b) payload.benzina = Number(b);
  if (d) payload.diesel = Number(d);
  if (!payload.benzina && !payload.diesel) {
    msg.textContent = 'Inserisci almeno un prezzo da aggiornare.'; return;
  }
  msg.textContent = 'Aggiornamento in corso...';
  const res = await fetch('/api/prezzi/provincia/' + encodeURIComponent(prov), {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload),
  });
  if (res.ok) {
    const data = await res.json();
    msg.textContent = `Aggiornati ${data.aggiornati} distributori in ${data.provincia}.`;
    loadAll();
  } else {
    const err = await res.text();
    msg.textContent = 'Errore: ' + err;
  }
});

loadAll();
</script>
</body>
</html>
